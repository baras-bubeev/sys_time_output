# sys_time_output
TASM 5.0
Задача:
Выводить ежесекундно в правом верхнем углу экрана системное время “часы:минуты:секунды”.
Описание:
Идентификатор old определяет ячейку памяти размером 4 байта, которая хранит адрес старого обработчика прерываний от таймера. Эта ячейка будет нужна, когда будет вызываться старый обработчик прерываний от таймера. Идентификатор buf определяет шаблон для формирования строки, содержащей значение текущего времени в формате часы:минуты:секунды. Последний байт в шаблоне - нулевой - нужен для определения длины шаблона.
Процедура decode преобразует двоично-десятичное число в регистре AL в два ASCII символа, соответствующих значению часов, минут или секунд (это зависит от конкретного значения, записанного в регистре AL). Процедура прибавляет к значению разряда числа (младший разряд находится в первых четырёх битах регистра AL, старший - в старших четырёх битах) ASCII код символа '0', тем самым формируя ASCII код для цифры младшего или старшего разряда. Далее этот ASCII код записывается в текущую позицию шаблона. После записи в шаблон значение указателя на текущий символ шаблона увеличивается на 3 (две цифры для часов, минут или секунд, плюс символ ':').
Процедура clock является обработчиком прерываний от таймера. Дело в том, что номер аппаратного обработчика прерываний от таймера - 08h. Но в системном обработчике этого аппаратного прерывания есть вызов INT 1Ch. Прерывание 1Ch определяет пользовательский обработчик прерываний от таймера, который вызывается системным. Таким образом, ячейка old хранит адрес старого пользовательского обработчика прерываний от таймера. В начале процедуры clock командой PUSHF в стеке подготавливается структура для команды IRET и затем вызывается старый пользовательский обработчик прерываний от таймера. Далее в процедуре clock сохраняются в стеке все модифицируемые регистры (в том числе и сегментные). После этого инициализируется сегментный регистр DS для последующего обращения к ячейкам памяти резидентной части программы. Следующим шагом является получение значения текущего времени из BIOS при помощи прерывания BIOS 1Ah. После вызова команды INT 1Ah в регистре CH находится значение часов, в регистре CL - значение минут и в регистре DH - значение секунд. Каждое значение представлено в двоично-десятичном формате - младший разряд числа находится в младших четырёх битах регистра, а старший разряд числа - в старших четырёх битах. После получения значения текущего времени регистр BX настраивается на начало шаблона для записи в шаблон значений часов, минут и секунд. Далее три раза вызывается процедура decode для записи в шаблон соответственно часов, минут и секунд. После записи в шаблон необходимой информации происходит вывод символов шаблона в правый верхний угол экрана. Для этого регистр ES настраивается на сегмент видеопамяти, а регистр DI присваивается значение 140. Далее в цикле происходит вывод в видеопамять символов шаблона и атрибутов. После этого восстанавливаются значения всех модифицируемых процедурой регистров и командой IRET происходит возврат из обработчика.
В основной части программы при помощи функции DOS 35h происходит получение адреса старого пользовательского обработчика прерываний от таймера (прерывание 1Сh). Значения сегмента и смещения старого обработчика записываются в ячейку old. Далее устанавливается адрес нашего обработчика прерываний от таймера. Для этого в регистр DX записывается смещение нашего обработчика (смещение процедуры clock) и вызывается функция DOS 25h (регистр DS уже содержит значение сегмента нашего обработчика). После этого происходит вызов функции DOS 31h, которая завершает программу и сохраняет часть её кода в памяти.